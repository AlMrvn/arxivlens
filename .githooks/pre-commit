
#!/bin/sh
echo "ğŸ›¡ï¸  Running pre-commit guards..."

# 1. Check for cargo-modules dependency
if ! command -v cargo-modules >/dev/null 2>&1; then
    echo "âš ï¸  cargo-modules not found."
    echo "Please run: cargo install cargo-modules --version 0.23.1 --no-default-features --locked"
    exit 1
fi

# 2. Architecture Boundary Check
echo "ğŸ” Checking architecture boundaries..."
# We use the surgical regex to ensure logic doesn't touch UI
if cargo modules dependencies --lib | grep -qE "arxivlens::arxiv.*->.*arxivlens::ui"; then
    echo ""
    echo "âŒ ARCHITECTURE VIOLATION DETECTED"
    echo "--------------------------------------------------------"
    echo "The 'arxiv' module is attempting to use the 'ui' module."
    echo "This breaks the unidirectional dependency rule: Logic cannot depend on UI."
    echo "--------------------------------------------------------"
    echo "Offending link:"
    cargo modules dependencies --lib | grep -E "arxivlens::arxiv.*->.*arxivlens::ui"
    exit 1
fi
echo "âœ… Architecture boundaries respected."

# 3. Style Check (Fast)
echo "ğŸ¨ Checking formatting..."
cargo fmt -- --check || { echo "âŒ Format check failed. Run 'cargo fmt'."; exit 1; }

# 4. Linting (Medium)
echo "ğŸ“ Running Clippy..."
cargo clippy -- -D warnings || { echo "âŒ Clippy failed."; exit 1; }

# 5. Functional Testing (Heavy)
echo "ğŸ§ª Running tests..."
cargo test || { echo "âŒ Tests failed."; exit 1; }

echo "ğŸš€ All guards passed. Committing..."
exit 0
